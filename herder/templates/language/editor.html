<%inherit file="/base.html"/>

<%def name="ds_url()">
 "${h.url_for(controller='language', action='strings', id=c.language.name, domain=c.domain.name)}"
</%def>

<%def name="head()">
    <link type="text/css" rel="stylesheet"
	  href="http://yui.yahooapis.com/2.5.0/build/datatable/assets/skins/sam/datatable.css"> 

    <script type="text/javascript"
	    src="http://yui.yahooapis.com/2.5.0/build/datasource/datasource-beta-min.js"></script> 

    <!-- JSON Utility -->
    <script type="text/javascript"
	    src="http://yui.yahooapis.com/2.5.0/build/json/json-min.js">
    </script> 

    <!-- Connection (enables XHR) -->
    <script type="text/javascript"
	src="http://yui.yahooapis.com/2.5.0/build/connection/connection-min.js">
    </script> 

    <script type="text/javascript" src="http://yui.yahooapis.com/2.5.0/build/dragdrop/dragdrop-min.js"></script>

<!-- OPTIONAL: Calendar (enables calendar editors)
<script type="text/javascript" src="http://yui.yahooapis.com/2.5.0/build/calendar/calendar-min.js"></script>
 -->

    <!-- Source files -->
    <script type="text/javascript"
    src="http://yui.yahooapis.com/2.5.0/build/datatable/datatable-beta-min.js"></script> 

<script type="text/javascript">
YAHOO.util.Event.addListener(window, "load", function() {

        var myColumnDefs = [
            {key:"id", label:"Name", sortable:true},
     % for l in c.addl_langs:
            {key:"${l}", label:"${l}", sortable:true},
     % endfor
            {key:"value", label:"Translation", editor:"textarea"},
        ];

        this.myDataSource = new YAHOO.util.DataSource(${self.ds_url()} + "?${c.addl_langs_qs}");
        this.myDataSource.responseType = YAHOO.util.DataSource.TYPE_JSON;
        this.myDataSource.connXhrMode = "queueRequests";
        this.myDataSource.responseSchema = {
            resultsList: "strings",
            fields: ["id","value", ${c.addl_langs_list}]
        };
 
        this.myDataTable = new YAHOO.widget.DataTable("strings_table", 
                myColumnDefs, this.myDataSource, {initialRequest:""});

 %if c.user:
        this.myDataTable.subscribe("cellClickEvent", 
                                   this.myDataTable.onEventShowCellEditor); 
        this.myDataTable.subscribe("editorSaveEvent", function(e) {
          // create an object to post back

          var edit = {id: e.editor.record.getData().id,
                      new_value: e.newData,
                      old_value: e.oldData};

          var edit_callback = {
             success: function(o) {
                // FIXME: Show the user the background process succeeded
             },
             failure: function(o) {
                // FIXME: Show the user the background process failed
             },
             argument:edit,
             cache:false,
          };

          // FIXME: Show the user a background process has started
          var transaction = YAHOO.util.Connect.asyncRequest('POST', 
                  "${h.url_for(controller='language', action='edit_string', id=c.language.name, domain=c.domain.name)}",
                  edit_callback, "data=" + YAHOO.lang.JSON.stringify(edit));
        });
  %endif

});
</script>

<script type="text/javascript">
    /**
     * Enables TEXTAREA Editor, also pulling in extra data from suggestions.
     *
     * @method DataTable.editTextareaPlusSuggestions
     * @param oEditor {Object} Object literal representation of Editor values.
     * @param oSelf {DataTable} Reference back to DataTable instance.
     * @static
     */
YAHOO.widget.DataTable.editTextareaPlusSuggestions = function(oEditor, oSelf) {
    var elCell = oEditor.cell;
    var oRecord = oEditor.record;
    var oColumn = oEditor.column;
    var elContainer = oEditor.container;
    var value = YAHOO.lang.isValue(oRecord.getData(oColumn.key)) ? oRecord.getData(oColumn.key) : "";

    var elTextbox = document.createElement("textarea");
    var div = document.createElement('div');
    div.appendChild(elTextbox);
    elContainer.appendChild(elTextbox);
    
    elTextbox.style.width = elCell.offsetWidth + "px";
    elTextbox.value = value;

    YAHOO.util.Event.addListener(elTextbox, "keyup", function(ev){
            oEditor.value = elTextbox.value;
        oSelf.fireEvent("editorUpdateEvent",{editor:oEditor});
    });

    elTextbox.focus();
    elTextbox.select();

    var callback = {
        failure: function(o) { }, /* Curious, maybe there should be error handling. */
        success: function(o) { 
            var data = YAHOO.lang.JSON.parse(o.responseText); 
            
            for (index in data['response']) {
                o.argument.elContainer.appendChild
                    (document.createTextNode("Suggestion by "));
                o.argument.elContainer.appendChild
                    (document.createTextNode(data[index]['author']));

                var div = document.createElement('div');
                /* Put the textarea in a div */
                var subdiv = document.createElement('div');
                var elTextbox = document.createElement('textarea');
                elTextbox.value = data[index]['suggestion'];
                subdiv.appendChild(elTextbox);
                div.appendChild(subdiv);

                /* Create buttons ... */
                var buttonsdiv = document.createElement('div');
                YAHOO.util.Dom.generateId(buttonsdiv);
                var accept_sugg_button = new YAHOO.widget.Button({
                        label: 'Copy',
                        container: buttonsdiv.id,
                    });
                accept_sugg_button.on("click", function(event) {
                        o.argument.elTextbox.value = elTextbox.value;
                    });
                var delete_sugg_button = new YAHOO.widget.Button({
                        label: 'Delete',
                        container: buttonsdiv.id,
                    });
                delete_sugg_button.on("click", function(event) {
                        alert('lol no');
                    });
                div.appendChild(buttonsdiv);
                /* throw away data[index]['author'] */
                o.argument.elContainer.appendChild(div);
            }
        },
        argument: {elContainer: elContainer,
                   elTextbox: elTextbox}
    }
    var request = YAHOO.util.Connect.asyncRequest('GET',
        "assets/data/suggestions.json", callback);

    };
</script>

</%def>

<%def name="body()">

%if c.user:
<p>You can click the text in the <strong>Translation</strong> column
  to edit a translation.</p>
  %if 'translate' not in c.user_roles:
  <p class="notice">Your submissions will be filed
    as <em>suggestions</em>, pending approval by a translator.</p>
  %endif
%else:
<p class="notice"><a href="/account/login">Login</a> to translate
  strings or make suggestions.</p>
%endif

<div id="strings_table">
</div>

</%def>
